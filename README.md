# Atlantis Configuration Repository for Serverless Deployments using AWS SAM

## Prerequisites

1. AWS CLI installed
2. AWS SAM CLI installed
3. Git installed
4. Configured AWS profile with valid credentials

## Install and Set Up

1. Create a repository with a name similar to `cfn-sam-configurations`
2. Place the files from this repository into it.

This will now be your SAM configuration repository where you will store the configurations for Pipelines, Network, Storage, and IAM stacks. Your applications will have their own, separate repositories.

### Make scripts executable

If using Linux or Mac OS, make the scripts executable.

```bash
chmod +x ./scripts/*.py
chmod +x ./scripts/*.sh
```

Doing this allows you to execute the scripts without having to specify `python`, `python3`, or `bash`. You can just do this:

```bash
./scripts/config.py service-role acme
```

### Configure default deployment configuration settings

1. **Determine a Prefix to use.** A Prefix can be considered a namespace that groups your applications and permissions by organizational unit or team. It further divides the naming of resources in your AWS Account even if you practice separation of units among AWS Organization Accounts.
2. **Gather any Role Path and Permissions Boundaries information from your AWS administrator.** Developers will need to be able to create execution roles in their application templates. If there are requirements around Role Paths and Permissions Boundaries to use, then we will need that to create the service role and require the developers to utilize when deploying their application templates.
3. **Determine the S3 bucket that will be used for deploy artifacts.** More than likely, if you have already performed a `sam deploy` command, an S3 bucket named `cf-some-name-autogenerated` was already created for you. Check your S3 buckets and use it. This will be used for the `s3_bucket` under `atlantis` in `defaults.json`.
4. **Update `defaults.json` with the appropriate information**: Using `./defaults/sample.defaults.json` as a guide, create `./defaults/defaults.json` and enter the appropriate information.

```json
{
	"atlantis": {
		"s3_bucket": "cf-acmeco-deployments",
		"region": "us-east-2",
		"confirm_changeset": true
	},
	"parameter_overrides": {
		"S3BucketNameOrgPrefix": "acmeco",
		"RolePath": "/app-role/",
		"PermissionsBoundaryArn": "arn:aws:iam::123456789012:policy/MyPermissionsBoundary"
	},
	"tags": [
		{
			"Key": "Department",
			"Value": "Web Services"
		},
		{
			"Key": "CostCenter",
			"Value": "123D"
		}
	]
}
```

For `s3_bucket` use the `cf-something` bucket that AWS created for you when you deployed your first SAM application. Or, use an S3 bucket that your organization uses to temporarily store application artifacts during deployment. Also fill in `region` with the region you will be deploying to.

```json
{
	"atlantis": {
		"s3_bucket": "cf-acmeco-deployments",
		"region": "us-east-2",
		"confirm_changeset": true
	}	
}
```

The next section is `parameter_overrides`. These will be default answers to many of the prompts you will be asked to fill in while creating SAM configurations for your infrastructure. There are 3 defaults you may need to use across all your deployments. These are optional and are determined by your organization. If your organization requires any of these you must provide them. Otherwise leave them as empty strings `""` or leave `parameter_overrides` as an empty object: `{}`.

```json
{
	"parameter_overrides": {
		"S3BucketNameOrgPrefix": "acmeco",
		"RolePath": "/app-role/",
		"PermissionsBoundaryArn": "arn:aws:iam::123456789012:policy/MyPermissionsBoundary"
	},
}
```

The tags section is for any tags you may wish to include default values for, such as Department or CostCenter. Tags are helpful in organizing your resources. Atlantis makes heavy use of tags, and even provides automated tags to assist. Entering these and saving them in your configurations right off the bat are a great way to start off on the right foot!

You can leave the `defaults/settings.json` file as-is for now. The 63klabs S3 buckets with sample templates and application code are provided for you to use as you start out. You can modify these later.

### Create the service role

The service role is what gives developers the proper permissions to manage their pipelines for automated application deployments. It restricts them to the creation of pipeline resources with tags and naming that fall under the assigned Prefix, and enforces the Role Path and Permissions Boundaries. The pipeline further enforces these permission constraints on the application resources being deployed.

The service role prevents developers from deploying AWS resources they are not permitted to deploy, and ensures that each application stack manages only those resources it is allowed under the Prefix naming and tagging convention.

Ensure your AWS CLI has valid credentials. If you are not using the `default` profile, be sure to add `--profile` to the commands. We will specify the `yourprofile` profile in these examples. Also, in these examples, we will use `acme` as the Prefix.

```bash
./scripts/config.py service-role acme --profile yourprofile
```

You will be given a series of prompts. 

If you are asked for a template to use, choose `template-service-role-pipeline.yml`.

### Create your application repository

> Currently these instructions are for creating a CodeCommit repository. You can similarly create a repository using your preferred git provider. Just download the code from the application starter GitHub repository.

The `create_repo.py` script can be used to create a CodeCommit repository and seed it with one of the available application starters.

```bash
./scripts/create_repo.py your-repo-name --profile yourprofile
```

You will then be asked to choose an application starter from the 63klabs S3 bucket. (See the Atlantis CloudFormation Template Repository for Serverless Deployments if you wish to set up your own bucket in the future.)

You will then be prompted to add in some tags for your repository. (You can specify what tags to request in the [defaults/settings.json](./defaults/settings.json) file and default values in `./defaults/defaults.json`)

### Atlantis starter templates

The Atlantis starter templates can be used to deploy many serverless solutions.

> For your first deployment using Atlantis, it is recommend you use the **00 Basic API Gateway Lambda Node.js** application starter.

Deploy the templates and applications AS-IS. After a successful deployment, you may then modify the code as needed.

Once you have explored the basic application, you can proceed to use the other starter applications listed below. Each utilize the [@chadkluck/cache-data npm package](https://www.npmjs.com/package/@chadkluck/cache-data) written and maintained by the same developer of this repository. The Cache-Data package includes functions to quickly implement routing, logging, monitoring, endpoint caching, and more.

The CloudFormation templates for each application feature definitions for CloudWatch alarms, logging, dashboards, X-Ray, Lambda Insights, and Swagger API documentation.

Start Here: 

- [00 Basic API Gateway Lambda Node.js](https://github.com/chadkluck/atlantis-app-starter-00-basic-apigw-lambda-nodejs/).

Then try the near production-ready application starters (recommended order):

1. 01 API Gateway, Lambda Python (coming eventually)
2. 02 API Gateway, Lambda Node.js with Cache-Data (coming eventually)
3. 03 Event Bridge, Lambda, Step Function (coming eventually)
4. 04 API Gateway, Lambda, S3 static content (coming eventually)
5. 05 Video Processing using Event Bridge, Lambda, Step Functions, Media Convert, Transcribe (coming eventually)
6. 06 Image processing using Event Bridge, Lambda, Step Functions (coming eventually)
